# 身份组同步模块 —— 使用指南

> 让你的 Bot 自动在多个 Discord 服务器之间同步成员的身份组（角色）。
>
> 例如：成员在 A 服获得「已验证」角色后，B 服也会自动给 TA 加上对应的「已验证」角色。

---

## TL;DR —— 5 分钟快速上手

### 第一步：配置环境变量

在 `.env` 中填写你要同步的两个服务器信息：

```env
ROLE_SYNC_LINKS_JSON=[{"linkId":"a_to_b","sourceGuildId":"A服ID","targetGuildId":"B服ID","enabled":true}]
```

> 把 `A服ID` 和 `B服ID` 替换为实际的服务器 ID（18 位数字）。`linkId` 随便取个名字就行。

### 第二步：确保 Bot 权限

- Bot 必须已加入 A 服和 B 服
- Bot 在两个服务器都需要 **管理身份组** 权限
- Discord Developer Portal 中需要开启 **Server Members Intent**

### 第三步：导出角色、制作同步计划

1. 在 Discord 中输入 `/身份组同步 导出链路角色`，选择你的 `link_id`
2. Bot 会给你两个 CSV 文件，分别是 A 服和 B 服的角色列表
3. 打开 CSV，找到你想同步的角色，记下它们的 ID
4. 制作一个计划文件（CSV 或 Excel），格式见下方 [计划文件怎么写](#计划文件怎么写)

### 第四步：导入 → 预检 → 应用

按顺序执行这三个命令：

```
/身份组同步 导入计划    →  上传你的计划文件，得到一个 job_id
/身份组同步 预检        →  填入 job_id，检查计划有没有问题
/身份组同步 应用        →  填入 job_id，确认执行设为 true，正式生效
```

### 第五步：采集成员 & 对账

```
/身份组同步 全量采集成员  →  让 Bot 知道哪些成员同时在两个服务器
/身份组同步 对账批次      →  检查并补齐漏掉的同步
```

**搞定！** 之后成员在 A 服的角色变动会自动同步到 B 服。

---

## 核心概念解释

### 什么是「链路」？

链路就是 **一对需要同步的服务器关系**。比如你有 A 服和 B 服要同步角色，这就是一条链路。如果还有 C 服也要和 A 服同步，那就是两条链路。

每条链路有一个你自己取的名字（`link_id`），比如 `main_to_sub1`。

### 什么是「角色映射」？

角色映射就是告诉 Bot：**A 服的哪个角色对应 B 服的哪个角色**。

比如：A 服的「已验证」（ID: 111）→ B 服的「贵宾」（ID: 222）。

一条链路下可以有很多组角色映射。

### 什么是「同步方向」？

你可以控制同步的方向：

| 同步模式 | 含义 |
|---|---|
| `source_to_target` | A 服变动 → 同步到 B 服（单向，**默认值**） |
| `target_to_source` | B 服变动 → 同步到 A 服（反向单向） |
| `bidirectional` | 双向同步，任何一边变动都会同步到另一边 |
| `disabled` | 暂停这组映射的同步 |

### 什么是「对账」？

对账 = **检查有没有漏同步的情况，并补上**。

有时候 Bot 离线、网络抖动等原因可能导致某些角色变动没被同步。对账就是扫描成员当前的角色，和应有的状态对比，把差异补上。

### 什么是「快照」？

每次你应用新的同步计划时，Bot 会自动保存当前配置的一份「快照」（备份）。如果配置出了问题，你可以用快照一键回滚到之前的状态。

---

## 计划文件怎么写

计划文件是一个 CSV 或 Excel 文件，告诉 Bot 要同步哪些角色。核心字段如下：

| 字段 | 必填？ | 说明 | 示例 |
|---|---|---|---|
| `action` | 是 | 操作类型 | `UPSERT`（新增/更新）、`DISABLE`（停用）、`DELETE`（删除） |
| `link_id` | 是 | 链路名称 | `main_to_sub1` |
| `source_guild_id` | 是 | 来源服务器 ID | `111111111111111111` |
| `target_guild_id` | 是 | 目标服务器 ID | `222222222222222222` |
| `source_role_id` | 是 | 来源角色 ID | `333333333333333333` |
| `target_role_id` | 视情况 | 目标角色 ID（如果要自动创建可以留空） | `444444444444444444` |
| `sync_mode` | 否 | 同步方向（默认 `source_to_target`） | `bidirectional` |
| `enabled` | 否 | 是否启用（默认 `true`） | `true` |
| `create_if_missing` | 否 | 目标角色不存在时是否自动创建 | `true` |
| `target_role_name_if_create` | 视情况 | 自动创建时用什么名字 | `已验证` |
| `max_delay_seconds` | 否 | 同步延迟上限（1~3600 秒） | `10` |
| `target_role_position` | 否 | 锚点位置（见下方说明） | `10` |
| `copy_visual` | 否 | 创建角色时是否复制颜色等外观 | `true` |
| `copy_permissions_mode` | 否 | 创建角色时是否复制权限（见下方说明） | `none`（默认）/ `safe` / `strict` |
| `notes` | 否 | 备注 | `基础角色` |

### 关于 `copy_permissions_mode`（权限复制模式）

自动创建角色时，可以选择是否从源角色复制权限：

| 模式 | 效果 |
|---|---|
| `none`（默认） | 不复制任何权限，新角色没有额外权限 |
| `safe` | 只复制安全权限（查看频道、发送消息、查看历史消息、嵌入链接、上传文件、添加反应、使用外部表情/贴纸、使用应用命令） |
| `strict` | 完整复制源角色的所有权限（包括管理权限等敏感权限） |

> 建议：除非你明确知道需要复制权限，否则保持默认的 `none`。`strict` 模式可能会意外授予管理员、踢人、封禁等敏感权限。

### 关于 `target_role_position`（锚点定位）

批量创建角色时，你**不需要给每个角色都填位置**。用法：

1. 在计划文件中按你想要的顺序排列角色（上面的行 = 角色列表中更高的位置）
2. 只需要在**其中一个角色**上填写 `target_role_position`，作为"锚点"
3. 其他角色留空，系统会自动按文件顺序依次排列在锚点上方和下方

**示例**：你的计划文件有 3 行角色，在第 1 行填了 `target_role_position=10`：
- 第 1 行角色 → 位置 10
- 第 2 行角色 → 位置 9
- 第 3 行角色 → 位置 8

如果在第 2 行（中间）填了 `target_role_position=10`：
- 第 1 行角色 → 位置 11
- 第 2 行角色 → 位置 10（锚点）
- 第 3 行角色 → 位置 9

**如果所有行都不填**，角色会被放到列表底部，不做位置调整。

> 注意：Bot 无法把角色移到比自己最高角色更高的位置，Discord 会自动限制。

### 最简示例

只需要这几列就能用：

```csv
action,link_id,source_guild_id,target_guild_id,source_role_id,target_role_id,sync_mode
UPSERT,main_to_sub1,111111111111111111,222222222222222222,333333333333333333,444444444444444444,source_to_target
```

### 注意事项

- 所有 ID 都是 17~20 位的数字字符串
- 如果 `target_role_id` 留空，必须把 `create_if_missing` 设为 `true`，并填写 `target_role_name_if_create`
- `DISABLE` 和 `DELETE` 操作必须填写 `target_role_id`

---

## 全部命令一览

所有命令都以 `/身份组同步` 开头，仅管理员可用。

### 日常使用

| 命令 | 用途 | 关键参数 |
|---|---|---|
| `导出当前服务器角色` | 导出当前服务器的所有角色为 CSV | 无 |
| `导出链路角色` | 同时导出链路两边服务器的角色 | `link_id` |
| `导入计划` | 上传同步计划文件 | 附件（CSV/Excel） |
| `预检` | 检查计划有没有问题（不会实际执行） | `job_id` |
| `应用` | 正式执行计划 | `job_id` + `确认执行: true` |
| `状态` | 查看同步系统当前运行状态 | 无 |

### 维护与修复

| 命令 | 用途 | 关键参数 |
|---|---|---|
| `对账成员` | 检查单个成员的角色是否正确并补齐 | `link_id` + `成员` |
| `对账批次` | 批量检查成员角色并补齐 | `link_id`，可选 `数量`、`偏移` |
| `触发自动对账` | 立即执行一轮自动对账 | 无 |
| `全量采集成员` | 采集成员信息用于对账 | `link_id` + `采集侧`（source/target/both） |

### 配置管理

| 命令 | 用途 | 关键参数 |
|---|---|---|
| `设置链路状态` | 启用或停用某条链路 | `link_id` + `启用`（true/false） |
| `快照列表` | 查看历史配置备份 | 可选 `link_id` |
| `回滚` | 恢复到之前的配置 | `snapshot_id` + `确认执行: true` |

---

## 常见场景操作步骤

### 场景一：第一次设置同步（从零开始）

1. 在 `.env` 中配置链路信息（见 [快速上手](#tldr--5-分钟快速上手)）
2. 启动 Bot
3. `/身份组同步 导出链路角色` → 查看两边有哪些角色
4. 制作计划文件（先只放 2~3 个角色试试）
5. `/身份组同步 导入计划` → 上传文件
6. `/身份组同步 预检` → 检查没问题
7. `/身份组同步 应用` → 正式生效
8. `/身份组同步 全量采集成员` → 采集侧选 `both`
9. `/身份组同步 对账批次` → 先用默认数量扫一扫
10. `/身份组同步 状态` → 确认一切正常

### 场景二：新增角色映射

1. 在之前的计划文件中添加新的行
2. `/身份组同步 导入计划` → `/身份组同步 预检` → `/身份组同步 应用`
3. 用 `/身份组同步 对账成员` 挑几个人验证一下

### 场景三：配错了，想恢复

1. `/身份组同步 快照列表` → 找到出错之前的快照 ID
2. `/身份组同步 回滚 snapshot_id:xxx 确认执行:true`
3. `/身份组同步 状态` → 确认已恢复

### 场景四：怀疑有成员角色没同步上

1. `/身份组同步 对账成员` → 先查单个人
2. `/身份组同步 对账批次` → 批量扫描补齐
3. 如果问题严重，`/身份组同步 触发自动对账`

---

## 环境变量参考

在 `.env` 中可以配置以下项目：

| 变量 | 必填？ | 默认值 | 说明 |
|---|---|---|---|
| `ROLE_SYNC_LINKS_JSON` | 是 | `[]` | 链路配置（JSON 数组） |
| `ROLE_SYNC_WORKER_INTERVAL_MS` | 否 | `3000` | 同步队列轮询间隔（毫秒） |
| `ROLE_SYNC_WORKER_BATCH_SIZE` | 否 | `20` | 每轮最多处理多少个同步任务 |
| `ROLE_SYNC_WORKER_FAST_BATCH_SIZE` | 否 | 按总批次 70% | 快速通道每轮处理数 |
| `ROLE_SYNC_WORKER_NORMAL_BATCH_SIZE` | 否 | 与总批次相同 | 普通通道每轮处理数 |
| `ROLE_SYNC_AUTO_RECONCILE_ENABLED` | 否 | `false` | 是否开启自动对账 |
| `ROLE_SYNC_AUTO_RECONCILE_INTERVAL_MS` | 否 | `900000`（15分钟） | 自动对账间隔 |
| `ROLE_SYNC_AUTO_RECONCILE_MAX_MEMBERS_PER_LINK` | 否 | `20` | 每轮每条链路最多扫描多少人 |

### 链路 JSON 格式

```json
[
  {
    "linkId": "main_to_sub1",
    "sourceGuildId": "111111111111111111",
    "targetGuildId": "222222222222222222",
    "enabled": true
  }
]
```

可以配置多条链路，用逗号分隔即可。

---

## 关于「快速通道」和「普通通道」

同步任务会根据 `max_delay_seconds` 的值自动分配到不同通道：

- **快速通道**（`max_delay_seconds` ≤ 20）：优先处理，延迟更低，适合重要角色
- **普通通道**（`max_delay_seconds` > 20）：正常排队处理，适合一般角色

不需要手动选择通道，系统会自动判断。

---

## 常见问题

**Q：Bot 报了网络错误 / ECONNRESET 怎么办？**
A：这是网络波动，系统会自动重试。等几秒再重试你的命令就好。

**Q：对账扫不到人？**
A：需要先执行「全量采集成员」让 Bot 知道哪些人同时在两个服务器。

**Q：「写入离开状态」是什么？什么时候用？**
A：正常情况不需要开。只有在你想完全重建成员状态数据时才开启，并且必须配合「数量上限 = 0」（全量采集）使用。

**Q：同步有延迟怎么办？**
A：可以把重要角色的 `max_delay_seconds` 设小（比如 10），让它走快速通道。

**Q：Bot 重启后同步还会继续吗？**
A：会的。同步任务存在数据库里，Bot 重启后会继续处理队列中未完成的任务。

---

## 安全建议

1. **先小范围测试**：第一次只同步 2~3 个不重要的角色，确认没问题再扩大
2. **权限复制建议关闭**：`copy_permissions_mode` 建议保持默认的 `none`，避免意外授予权限
3. **记住快照号**：每次应用后记下快照号，方便出问题时快速回滚
4. **自动对账先不开**：等手动测试稳定后，再开启自动对账（设置 `ROLE_SYNC_AUTO_RECONCILE_ENABLED=true`）
