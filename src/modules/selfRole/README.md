# 自助身份组申请模块 (`selfRole`)

## 概述

本模块为服务器提供了一个功能强大且可扩展的通用自助身份组申请系统。管理员可以通过一个统一的交互式**管理面板**来配置所有可申请的身份组及其条件，而无需使用繁琐的斜杠命令。用户通过另一个独立的申请面板，即可自助申请符合条件的身份组。

---

## 功能特性

- **统一管理面板**: 管理员使用 `/创建管理面板` 命令，即可生成一个包含“添加”、“移除”、“列表”功能的交互式面板，集中管理所有规则。
- **现代化交互**: 无论是管理员配置还是用户申请，全程使用按钮、选择菜单和模态窗口，直观高效。所有交互均为仅自己可见的临时消息，不干扰公共频道。
- **灵活的条件配置**: 支持为每个身份组独立设置复杂的申请条件组合：
    - **前置身份组**: 要求用户必须拥有某个特定身份组。
    - **频道活跃度**: 要求用户在指定频道内的**发言数**或**被提及数**达到一定阈值。
    - **社区投票审核**: 在满足所有前置条件后，自动在一个指定的审核频道发起投票，由特定身份组的用户投票决定是否最终授予。
- **可扩展框架**: 系统的核心是围绕“条件检查器”构建的，未来可以轻松地加入更多新的申请条件类型（如加入服务器时长、拥有特定数量的身份组等），而无需重构核心代码。
- **高性能数据统计**:
    - **历史数据回溯**: 提供一次性命令，可扫描并统计频道内的所有历史消息，为活跃度检查提供数据基础。
    - **实时数据统计**: 采用“内存缓存 + 定时批量写入”的高性能模式，实时、高效地统计新消息，避免了频繁的磁盘I/O操作，保证了机器人的高性能响应。

---

## 数据收集与处理

本模块涉及三种核心数据的收集与处理：

1.  **配置数据 (`data/selfRoleSettings.json`)**:
    *   **收集方式**: 由管理员通过管理面板的“添加”功能，在弹出的模态窗口中录入。
    *   **数据内容**: 存储每个可申请身份组的ID、显示名称、描述以及一个包含所有申请条件的 `conditions` 对象。
    *   **处理方式**: 数据被安全地存储在服务器本地的JSON文件中。

2.  **用户活跃度数据 (`data/userActivity.json`)**:
    *   **收集方式**:
        *   **实时收集**: 通过监听 `messageCreate` 事件，当有用户在被监控的频道发言或被提及时，数据会先被累加到机器人的**内存缓存**中。
        *   **历史收集**: 管理员可通过 `/回溯统计活跃度` 命令，让机器人遍历指定频道的全部历史消息，将统计结果直接写入数据文件。
    *   **处理方式**:
        *   为了保证高性能，实时收集的数据并不会立即写入硬盘。
        *   一个后台的**定时任务**会周期性地将内存中累积的所有更新**批量写入**到 `userActivity.json` 文件中。

3.  **投票申请数据 (`data/selfRoleApplications.json`)**:
    *   **收集方式**: 当一个需要审核的申请被发起时，系统会自动在该文件中创建一条记录。
    *   **数据内容**: 存储申请人ID、申请的身份组ID、投票人列表等。
    *   **处理方式**: 该文件只存储**正在进行中**的投票。一旦投票结束（无论通过或拒绝），对应的记录在完成其使命（展示结果）后，就会被**自动删除**，以保持数据文件的整洁和高效。

---

## 命令使用说明

### 管理员命令

**1. `/创建管理面板`**
*   **功能**: 在当前频道创建一个永久性的**管理员操作面板**。此面板应放置在仅管理员可见的频道中。
*   **面板功能**:
    *   **添加身份组**: 弹出一个分页的身份组选择菜单，选择后出现模态窗口，让管理员填写所有申请条件。
    *   **移除身份组**: 弹出一个已配置身份组的选择菜单，选择后即可移除。
    *   **列出身份组**: 显示当前所有已配置的可申请身份组及其详细条件。

**2. `/创建自助身份组面板`**
*   **功能**: 在当前频道创建一个永久性的**用户申请入口面板**。此面板应放置在所有用户可见的频道。
*   **参数**:
    *   `标题` (必填): 面板的标题。
    *   `描述` (可选): 面板的描述内容。
    *   `按钮文字` (可选): 按钮上显示的文字，默认为“申请身份组”。

**3. `/回溯统计活跃度`**
*   **功能**: 扫描并统计一个频道的历史消息。
*   **参数**:
    *   `频道` (必填): 要扫描的频道。
    *   `扫描天数` (可选): 只扫描最近N天的消息，不填则扫描全部历史。
    *   `重置数据` (可选): 在扫描前是否清空该频道的现有统计数据。

**4. `/debug-roles` (调试命令)**
*   **功能**: 获取并显示服务器内所有身份组的详细列表。

### 用户命令

**1. `/查询我的活跃度`**
*   **功能**: 查询自己在所有或特定被监控频道中的发言和被提及数。
*   **参数**:
    *   `频道` (可选): 如果指定，则只显示该频道的统计数据。