# 选举模块

这是一个完整的Discord服务器选举系统，支持多职位竞选、第一第二志愿设置、自动化时间管理等功能。

## 📋 功能特性

### 🏗️ 管理员功能
- **设置选举职位** - 创建和配置选举职位，设置每个职位的当选人数
- **设置时间安排** - 配置报名和投票的开始结束时间
- **创建报名入口** - 在指定频道生成报名按钮，用户可以点击报名
- **自动投票生成** - 报名结束后自动生成各职位的投票器
- **清除用户投票** - 撤销指定用户的投票（处理后悔投票的情况）
- **查看操作日志** - 查看投票清除操作的详细记录

### 👥 用户功能
- **一键报名** - 点击按钮即可开始报名流程
- **志愿选择** - 支持设置第一志愿和第二志愿职位
- **自我介绍** - 可选填写自我介绍，向其他用户展示自己
- **报名管理** - 支持编辑报名信息或撤回报名
- **投票参与** - 为支持的候选人投票

### 🤖 自动化功能
- **时间管理** - 自动在指定时间开始/结束报名和投票
- **结果计算** - 自动计算选举结果，处理第二志愿逻辑
- **结果公布** - 选举结束后自动公布结果

## 🚀 使用指南

### 1. 设置选举职位
```
/设置选举职位 选举名称:2024年理事会选举 职位配置:会长:1,副会长:2,秘书长:1
```

### 2. 设置时间安排
```
/设置选举时间安排 报名开始时间:2024-03-10 09:00 报名结束时间:2024-03-15 18:00 投票结束时间:2024-03-20 18:00
```

### 3. 创建报名入口
```
/设置报名入口 频道:#选举频道
```

### 4. 用户参与流程
1. 点击"开始报名"按钮
2. 选择第一志愿职位
3. 选择第二志愿职位（可选）
4. 填写自我介绍（可选）
5. 确认提交报名

### 5. 投票阶段
- 报名结束后系统自动生成投票器
- 用户可为每个职位选择支持的候选人
- 投票结束后自动计算并公布结果

### 6. 投票管理（管理员功能）

#### 清除用户投票
```
/清除募选投票 用户:@目标用户 [voteid:投票ID] [electionid:选举ID] [原因:操作原因]
```

**使用场景：**
- 用户投票后后悔，希望撤销投票
- 需要清除错误的投票记录
- 处理投票纠纷或异常情况

**参数说明：**
- `用户`（必填）：要清除投票的用户
- `voteid`（可选）：特定投票ID，不填则清除该用户在当前选举中的所有投票
- `electionid`（可选）：特定选举ID，不填则使用当前活跃选举
- `原因`（可选）：清除投票的原因，会记录在日志中

#### 查看投票清除日志
```
/查看投票清除日志 [行数:50]
```
- 查看投票清除操作的历史记录
- 支持指定查看行数（10-200行）
- 显示操作者、目标用户、清除内容等详细信息

#### 更新投票候选人
```
/更新投票候选人 [选举id:选举ID]
```

**使用场景：**
- 投票开始后管理员手动在JSON文件中添加了新的候选人
- 需要同步投票器显示的候选人名单
- 确保投票器与最新的报名数据保持一致

**参数说明：**
- `选举id`（可选）：特定选举ID，不填则使用当前活跃选举

**功能特点：**
- 自动从registrations.json读取最新候选人数据
- 与votes.json中的候选人进行对比，找出新增候选人
- 更新投票器的候选人列表和Discord消息
- 保持现有投票数据不变，只添加新候选人
- 支持匿名和实名两种投票模式
- 提供详细的更新结果报告

## 📊 第二志愿逻辑

1. **第一志愿优先**：优先处理所有第一志愿的投票结果
2. **第二志愿补充**：第一志愿落选者可以参与第二志愿职位的竞争
3. **避免重复当选**：已在第一志愿当选的用户不会再在第二志愿中当选
4. **空位填补**：如果某职位第一志愿候选人不足，第二志愿候选人可以补充

## 🗂️ 文件结构

```
src/modules/election/
├── commands/           # Discord斜杠命令
├── components/         # 按钮、模态框等交互组件
├── services/          # 业务逻辑服务
├── data/             # JSON数据存储
├── utils/            # 工具函数
└── README.md         # 说明文档
```

## 💾 数据存储

使用JSON文件存储数据，包括：
- `elections.json` - 选举配置信息
- `registrations.json` - 用户报名记录
- `votes.json` - 投票数据
- `logs/vote_removal_logs.txt` - 投票清除操作日志

## ⚙️ 技术特性

- **防Discord限制**：避免3秒交互限制和15分钟消息过期
- **分步处理**：报名流程分步骤进行，提升用户体验
- **数据验证**：完整的输入验证和错误处理
- **时间管理**：精确的时间调度和状态管理
- **结果计算**：复杂的第二志愿逻辑处理
- **投票管理**：支持投票撤销和详细的操作审计
- **日志记录**：完整的操作日志记录和自动清理

## 🔒 权限管理

- 只有服务器管理员可以设置选举
- 只有服务器管理员可以清除用户投票和查看操作日志
- 所有服务器成员都可以参与报名和投票
- 每人每个选举只能报名一次
- 每人每个职位只能投票一次
- 投票清除操作需要二次确认

## 📝 注意事项

1. **时间格式**：使用 `YYYY-MM-DD HH:mm` 格式设置时间
2. **职位配置**：使用 `职位名:人数` 格式，多个职位用逗号分隔
3. **频道权限**：确保机器人在目标频道有发送消息权限
4. **数据备份**：定期备份JSON数据文件

## 🆘 故障排除

### 常见问题

**Q: 报名按钮点击后没有反应？**
A: 检查报名时间是否已开始，或者用户是否已经报名过

**Q: 投票器没有自动生成？**
A: 确认报名时间已结束，或者检查是否有候选人报名

**Q: 时间设置错误？**
A: 使用正确的时间格式，确保结束时间晚于开始时间

**Q: 权限错误？**
A: 确保用户有管理员权限（设置功能）或者机器人有必要的频道权限

**Q: 无法清除投票？**
A: 确保选举处于投票阶段，已完成的选举不允许清除投票

**Q: 投票清除日志在哪里？**
A: 使用 `/查看投票清除日志` 指令查看，或直接查看 `logs/vote_removal_logs.txt` 文件

## 🔄 更新日志

### v1.1.0
- 新增投票清除功能，支持撤销用户投票
- 新增投票清除日志查看功能
- 增强了投票管理和审计能力
- 添加了二次确认机制和详细日志记录

### v1.0.0
- 基础选举功能实现
- 支持多职位竞选
- 第一第二志愿机制
- 自动化时间管理
- JSON数据存储 